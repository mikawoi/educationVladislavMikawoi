
![[Pasted image 20240106165122.png]]
![[Pasted image 20240106165140.png]]

Программирование по контракту

- обязанности сторон
  - клиент: корректные входные данные
  - поставщик: корректная работа и результат
- соблюдение контракта
  - кто нарушил, тот и виноват

Контрактные отношения

- могут быть между частями программы
	 программа - программа
- не определены с внешней средой
	программа - человек
	программа - внешний мир

Обработка входных данных
- архитектура
  - модули ввода 
  - модули обработки
- гарантия корректности входных данных для обрабатывающих модулей

Контракты в исходном коде

- должны быть описаны в комментариях
- для проверки assert (условие)
*пример*
```cpp
#include <cassert>

int findBest(const Data* pData) {
	//если false, завершить работу программы
	assert(0 != pData);
	//основной код
}
```

### Обработка исключений в C++
исключения - вспомогательный код, который что-то делает, если что-то случилось не так

- модель с завершением
  - автоматическое продолжение программы невозможно
  - обработчик освобождает ресурсы и отдает управление на верхний уровень
- механизм обработки опциональный (опции компилятора)
механизм отличается от обычной программы: далее либо сколько-то работает и находится решение и программа продолжает свое исполнение с точки остановки, либо такой точки нет и работа программы прекращается.


Идеи обработки исключений
- разделить основной код и код обработки сбоев
- обрабатывать сбои на том уровне, на котором это может быть сделано
- усложнить игнорирование появления сбоев
- унифицировать способ передачи информации и сбое

Запуск исключений

- в системе создается объект с информацией об исключении, который запускается из текущего контекста
- нормальное исполнение программы прекращается и начинается обработка исключения

Источники исключений

- обработка аппаратных прерываний
- функции стандартной библиотеки
- функции системных библиотек
- пользовательский код

Исключение - 

- может быть любого типа (пользовательский, встроенный)
- несет информацию о проблеме
  - имя класса (типа) исключения
  - данные экземпляра исключения
- создается и копируется в точке запуска

Запуск исключений, пример
![[Pasted image 20240106171426.png]]

Локализация блоков с исключениями

- try-блок - составная инструкция, при выполнении которой могут генерироваться исключения
- try-блок сопровождается одним или несколькими блоками обработки исключений (cath-блоки)

Обработка исключений

- обработчик исключений
	  - осуществляет перехват и обработку исключений
	  - располагается сразу после блока try
	  - начинается сразу после слова cath
- Может использовать пойманное исключение и получать из него информацию
![[Pasted image 20240106172007.png]]

Раскрутка стека

- просмотр стека и поиск подходящего обработчика для исключения
- по мере раскрутки стека автоматически уничтожаются локальные объекты
- порядок разрушения обратный порядку создания

Когда объект создан?

- объект считается созданным после завершения работы конструктора
- составной объект считается созданным после создания всех входящих в него объектов
- массив считается созданным после создания всех его элементов

Автоматическое разрушение

- производится в процессе раскрутки стека только для созданных
- таким образом в массиве только для тех элементов, что были созданы

Поиск подходящего обработчика

- просматриваются ближайшие обработчики в порядке следования в исходном коде
- объект (ссылка на него) исключения производного класса перехватывается обработчиком базового класса
- при запуске указателя  поиск идет по стандартным правилам преобразования указателей

Перехват исключений
![[Pasted image 20240106173137.png]]

Преобразования исключений

- обработчик объекта базового типа усекает исключение производного типа до базового
- автоматическое преобразования одного типа исключений к другому не производятся

Для перехватывания исключений рекомендуется использовать константные ссылки
- избегаем копирования объекта исключения
- избегаем усечения до родительского типа
- гарантируем постоянство объекта исключения

Перехват любых исключений
- список аргументов
- следует размещать в конце списка перехватчиков
- невозможно получить информацию об исключении и его типе
*пример*
```cpp
try {
	//code
} catch (const std::bad_alloc& ex) {
	//обработка bad_alloc
} catch (...) {
	//обработка всего остального
}
```

Перезапуск исключения

- передает исключение далее
- необходим, если текущий обработчик не может выполнить всю работу
- вызывается throw без аргумента внутри обработчика исключения
```cpp
try {
	//code
} catch (const Ex1& ex1) {
	//обработка
	throw;
} catch (...) {
	//обработка всего остального
	throw;
}
```

Вызов terminate - вызывается когда исключение не было обработано, для завершения программы

- неперехваченное исключение
- исключение в деструкторе локального объекта при раскрутке стека
- исключение в конструкторе или деструкторе глобального или статического объекта 
- нарушение noexcept спецификации
- приостанавливает раскрутку стека
- по умолчанию вызывает abort() из системной библиотеки

Спецификация исключений
запрещено использовать

- часть объявления функции
- список типов исключений, которые могут быть сгенерированы функцией
```cpp
void func(int a) throw(Ex1, Ex2);
```

Спецификатор noexcept

- применим к функциям и производным типам
- noexcept не является частью типа
- переопределяемые виртуальные функции должны иметь не менее строгую спецификацию исключений
![[Pasted image 20240106175216.png]]

Запуск исключений из noexcept функции приводит к std::terminate()

при аккуратном использовании
- ускорение работы стандартных алгоритмов
- уменьшение объема исполняемого кода

Стандартные исключения

- образуют иерархию классов
- объявлены в пространстве имен std
- объявлены в заголовочных файлах
![[Pasted image 20240106175812.png]]

фрагмент иерархии
```cpp
std::exception
	-logic_error
		-length_error
		-out_of_range
		-invalid_argument - неверный аргумент
	-runtime_error
		-range_error - ошибка диапазона
		-overflow_error - переполнение
```

Перехватывать исключения надо там, где
- есть достаточно информации для обработки сбоя
- с целью
  - - обработать сбой
  - - преобразовать исключение
  - - соблюсти границы подсистем

Гарантии безопасности исключений

- базовая гарантия
  - сбой может изменить состояние, не вызывает утечек и оставляет все объекты пригодными для дальнейшего использования
- строгая гарантия
  - сбой не изменяет состояния (транзакция)
- гарантия бессбойности
  - сбой не может произойти

Сбои и повторное использование

- устойчивость и цена разработки должны соответствовать решаемой задаче
- требования к устойчивости неизвестны
- сообщение пользователю
  - неизвестны доступные устройства вывода
  - неизвестно наличие пользователя



## Абстрактный тип данных (АТД)

- описывает набор операций
  - создание/уничтожение
  - изменение
  - получение описания
*примеры*
число, строка, массив, стек, очередь

Структура данных

- способ организации и манипуляции данными (в памяти)
- реализация АТД (в исходном коде)
*примеры*
кортеж, массив, список, дерево, граф

#### Инвариант типа

- состояние экземпляра
  - значение всех переменных
  - может изменяться методами
  - может изменяться прямым изменением полей
- определяется типом

- должен выполняться в начале и конце каждого метода
- может контролироваться assert, специальные методы

АТД <<число>>

- создание, уничтожение, копирование
- сравнение
- арифметические операции
- ввод и вывод

АТД <<матрица>>

- создание, уничтожение, копирование
- получение доступа к элементу по индексу (iRow, iCol)
- получение размера по измерению
- изменение размера по измерению
- печать
Операции могут быть как 
алгебраические
- умножение матрицы на число
- сложение двух матриц
- умножение двух матриц
поэлементные
- сложение
- умножение и деление

дополнительные
- транспонирование
- срезы
- вставка/удаление строк или столбцов
- перестановка строк или столбцов
- сложение двух строк или столбцов
- умножение на число строки или столбца

Приведенной индекс
- размеры матрицы
- массив элементов матрицы![[Pasted image 20240106182558.png]]

Массив массивов это не матрица, так как 
- может быть ожерелье
- элементы могут иметь разную длину![[Pasted image 20240106182713.png]]
Массив строк/столбцов

- массив элементов матрицы
- массив индексов начала строк/столбцов![[Pasted image 20240106182759.png]]
Оценка реализации
- зависит от типового набора операций и распределения частот операций
- в массиве строк/столбцов быстрая перестановка строк/стобцов